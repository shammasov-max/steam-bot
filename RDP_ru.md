Хорошо, я пересмотрел всю нашу переписку и отобрал детали, которые мы обсуждали, но в финальном PRD они либо не были явно указаны, либо были упомянуты вскользь.
Дополнил их в расширенную версию PRD, сохранив текущую структуру, но усилил описание и контекст. Это не переписывание всего с нуля, а именно **насыщение** документа фактами и уточнениями.

---

# PRD: Мультичат для ИИ-ботов Steam (MVP v0.1, расширенная версия)

## 1) Контекст и цель

Мы создаём систему, способную управлять крупным пулом ботов Steam, которые взаимодействуют с реальными игроками в рамках торговых сценариев.
Сценарий MVP — **"make it work"**: сначала добиться стабильной работы на малом функционале, не тратя время на преждевременную оптимизацию, потом расширять и ускорять.
Система должна быть **дружественной для разработчика и PM**:

* Прозрачные статусы ботов, задач и чатов.
* Предсказуемое поведение, без “магии”.
* Возможность перехвата и управления агентом в реальном времени.

## 2) Пользователи и сценарии

**Основные пользователи:**

* **Разработчик:** интегрирует, деплоит и следит за ботами; умеет работать с maFile и proxy; важна гибкость API.
* **PM/Оператор:** управляет процессом продаж через чат; вручную вмешивается в диалоги.

**Ключевые сценарии (MVP):**

1. Постепенное подключение большого числа ботов по maFile (в перспективе до 10 000).
2. Назначение задач (привязка игрока + предмет + диапазон цен).
3. Автоматическое добавление игрока в друзья → запуск короткого скриптового диалога от ИИ-агента.
4. Возможность перехватить чат в любой момент, писать вручную, потом вернуть управление агенту.
5. Ведение центрального мультичата, работающего для нескольких операторов одновременно.
6. Возможность добавлять новые задания и ботов без остановки системы.

## 3) Объём MVP

* Подключение ботов через maFile (1 бот = 1 sticky proxy).
* Создание/удаление задач через команды `CreateTask` и `DisposeTask`.
* Распределение задач между ботами через round-robin (с пропуском оффлайн-ботов).
* Лимит инвайтов: 1 в минуту на бота.
* Автоматический скриптовый диалог (3–5 сообщений).
* Ручной перехват агента в чате.
* Логи событий на сервере (текстовый ndjson).
* UI: список ботов, задач, чатов; мультичат с индикатором агента.

## 4) Ограничения и правила платформы

* Steam API — только неофициальные обёртки (npm).
* Авторизация по maFile (Steam Guard).
* Прокси обязательно sticky (один IP на одного бота).
* Возможность подключения тысяч ботов одновременно, но в MVP можно работать с 10–100 подключениями в онлайне, проверяя остальных по кругу.
* Не нужно импортировать CSV напрямую — задачи создаются по одной командой API.
* Система должна поддерживать многопользовательский фронтенд (несколько операторов одновременно).
* Полный state (snapshot) может достигать десятков мегабайт, время загрузки фронта до 10 секунд считается допустимым.

## 5) Архитектура

**Backend:**

* Node.js + TypeScript.
* Функциональный стиль с использованием effect-ts.
* Один инстанс (в MVP) под pm2, без pub/sub.
* In-memory стор + snapshot на диск.

**Frontend:**

* Next.js (React).
* SSE для получения событий, HTTP POST для команд.
* Redux store (одинаковый на фронте и бэке, изоморфный пакет).

**Изоморфный пакет:**

* Полный список событий (`PayloadSchemas`).
* Redux actions, где `type === kind`.
* Генерация ID через `typeid-js` с префиксом по срезу.
* Enum-статусы для ботов и задач.
* Строгое использование UTC ms epoch.

## 6) Протокол обмена (CQRS-lite)

* **SSE `/api/event-stream`**:

  * Первое сообщение: `snapshot` всего состояния.
  * Дальше — батчи событий (каждые 50–100 мс).
  * При reconnect — новый snapshot, без реплея.
* **HTTP `/api/command`**:

  * Принимает команды.
  * Возвращает `{ ok: true }` или `{ ok: false, error }`.
  * Ошибки исполнения — события `error.logged`.

## 7) Доменная модель

* **Bot:** `{ id, steamId64, label?, proxyUrl, status, lastSeen? }`
  Статусы: `connecting | connected | disconnected | authFailed`.
* **Task:** `{ id, playerSteamId64, item, priceMin, priceMax, status, assignedBotId? }`
  Статусы: `created | assigned | invited | accepted | failed | disposed | resolved`.
* **Chat:** `{ id, botId, playerSteamId64, agentEnabled, messages[], scriptStep? }`
  Сообщения: `{ id, from: 'bot' | 'player', text, ts }`.

## 8) События

* `snapshot`
* Боты: `bot.connected`, `bot.disconnected`, `bot.authFailed`
* Задачи: `task.created`, `task.assigned`, `task.statusChanged`
* Инвайты: `friendInvite.sent`, `friendInvite.accepted`, `friendInvite.failed`
* Чаты: `chat.started`, `chat.messageReceived`, `chat.messageSent`, `chat.agentToggled`
* Скрипт: `dialogScript.advanced`, `dialogScript.completed`
* Логи: `error.logged`

## 9) Команды

* `AddBotFromMaFile`
* `RemoveBot`
* `CreateTask`
* `DisposeTask`
* `ToggleAgent`
* `SendMessage`

## 10) Логика

* InviteScheduler: инвайт ≤1/мин.
* TaskAssigner: round-robin.
* ChatAgent: ведёт скриптовый диалог.
* Ручной перехват: toggle `agentEnabled`.

## 11) Логи и наблюдаемость

* events.ndjson (append-only).
* Ошибки в stderr и `error.logged`.
* Метрики: кол-во ботов, чатов, событий/сек.

## 12) Acceptance Criteria

* Подключение бота — ≤10 секунд.
* Создание задачи → назначение по RR.
* Лимит инвайтов соблюдается.
* Чат создаётся после `friendInvite.accepted`.
* Агент можно выключить/включить в любой момент.
* Два фронтенда видят одинаковое состояние.

## 13) Риски

* Блокировки Steam: смягчаем лимитами и прокси.
* Потеря данных при падении — снапшоты и логи.
* Потеря событий при обрыве SSE — переподключение со snapshot.

---

Если хочешь, я могу собрать **этот расширенный PRD и код изоморфного пакета** в единый ZIP, чтобы можно было стартовать новый чат с полным вводом и чистым контекстом.

